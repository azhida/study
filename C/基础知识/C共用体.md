## C 共用体
#### 返回 [C基础知识](../C基础知识.md)


***


**共用体**是一种特殊的数据类型，允许您在相同的内存位置存储不同的数据类型。您可以定义一个带有多成员的共用体，但是任何时候只能有一个成员带有值。共用体提供了一种使用相同的内存位置的有效方式。  


#### 定义共用体
为了定义共用体，您必须使用 union 语句，方式与定义结构类似。union 语句定义了一个新的数据类型，带有多个成员。union 语句的格式如下：
```
union [union tag]
{
   member definition;
   member definition;
   ...
   member definition;
} [one or more union variables];
```
**union tag** 是可选的，每个 member definition 是标准的变量定义，比如 int i; 或者 float f; 或者其他有效的变量定义。在共用体定义的末尾，最后一个分号之前，您可以指定一个或多个共用体变量，这是可选的。下面定义一个名为 Data 的共用体类型，有三个成员 i、f 和 str：  
```
union Data
{
   int i;
   float f;
   char  str[20];
} data;
```
现在，**Data** 类型的变量可以存储一个整数、一个浮点数，或者一个字符串。这意味着一个变量（相同的内存位置）可以存储多个多种类型的数据。您可以根据需要在一个共用体内使用任何内置的或者用户自定义的数据类型。  
共用体占用的内存应足够存储共用体中最大的成员。例如，在上面的实例中，Data 将占用 20 个字节的内存空间，因为在各个成员中，字符串所占用的空间是最大的。下面的实例将显示上面的共用体占用的总内存大小：  
```
#include <stdio.h>
#include <string.h>

union Data
{
   int i;
   float f;
   char  str[20];
};

int main( )
{
   union Data data;        
 
   printf( "Memory size occupied by data : %d\n", sizeof(data));
 
   return 0;
}
```
当上面的代码被编译和执行时，它会产生下列结果：
```
Memory size occupied by data : 20
```


#### 访问共用体成员
为了访问共用体的成员，我们使用 **成员访问运算符（.）** 。成员访问运算符是共用体变量名称和我们要访问的共用体成员之间的一个句号。您可以使用 union 关键字来定义共用体类型的变量。下面的实例演示了共用体的用法：  
```
#include <stdio.h>
#include <string.h>

union Data
{
   int i;
   float f;
   char  str[20];
};

int main( )
{
   union Data data;        
 
   data.i = 10;
   data.f = 220.5;
   strcpy( data.str, "C Programming");
 
   printf( "data.i : %d\n", data.i);
   printf( "data.f : %f\n", data.f);
   printf( "data.str : %s\n", data.str);
 
   return 0;
}
```
当上面的代码被编译和执行时，它会产生下列结果：
```
data.i : 1917853763
data.f : 4122360580327794860452759994368.000000
data.str : C Programming
```
在这里，我们可以看到共用体的 i 和 f 成员的值有损坏，因为最后赋给变量的值占用了内存位置，这也是 str 成员能够完好输出的原因。现在让我们再来看一个相同的实例，这次我们在同一时间只使用一个变量，这也演示了使用共用体的主要目的：  
```
#include <stdio.h>
#include <string.h>

union Data
{
   int i;
   float f;
   char  str[20];
};

int main( )
{
   union Data data;        
 
   data.i = 10;
   printf( "data.i : %d\n", data.i);
   
   data.f = 220.5;
   printf( "data.f : %f\n", data.f);
   
   strcpy( data.str, "C Programming");
   printf( "data.str : %s\n", data.str);
 
   return 0;
}
```
当上面的代码被编译和执行时，它会产生下列结果：
```
data.i : 10
data.f : 220.500000
data.str : C Programming
```
在这里，所有的成员都能完好输出，因为同一时间只用到一个成员。




## 读者笔记


***


**结构体与共用体**  
结构体变量所占内存长度是其中最大字段大小的整数倍（参考：[结构体大小的计算]( https://www.runoob.com/w3cnote/struct-size.html )）。  
共用体变量所占的内存长度等于最长的成员变量的长度。例如，教程中定义的共用体Data各占20个字节（因为char str[20]变量占20个字节）,而不是各占4+4+20=28个字节。  
```
union Data
{
   int i;
   float f;
   char  str[20];
} data; 
```


***


**共用体作用**  
节省内存，有两个很长的数据结构，不会同时使用，比如一个表示老师，一个表示学生，如果要统计教师和学生的情况用结构体的话就有点浪费了！用共用体的话，只占用最长的那个数据结构所占用的空间，就足够了！  
**共用体应用场景**  
通信中的数据包会用到共用体:因为不知道对方会发一个什么包过来，用共用体的话就很简单了，定义几种格式的包，收到包之后就可以直接根据包的格式取出数据。  


***


```
union Data{
    int i;
    float f;
    char str[9];
    double d;
}data;
```
共用体所占内存并非是9个char，即9个字节，而是double的两倍，即16个字节，而且每次输出都是它前面离它最近的值


***


**编程时经常会需要判断机器是大端机还是小端机，此时使用union就非常方便：**  
```
union
{
    char str;
    int data;
};

data=0x01020304;

if(str==0x01)
{
    cout<< "此机器是大端！"<<endl;
}
else if(str==0x04){
    cout<<"此机器是小端！"<<endl;
}
else{
    cout <<" 暂无法判断此机器类型！"<<endl;
}
```
注：大端机高位存在低位，小端机反之


***


看了前面大家的内存占用大小计算，都没有分析到点，下面给出部分概念：
- 位："位(bit)"是电子计算机中最小的数据单位。每一位的状态只能是0或1。
- 字节：8个二进制位构成1个"字节(Byte)"，它是存储空间的基本计量单位。1个字节可以储存1个英文字母或者半个汉字，换句话说，1个汉字占据2个字节的存储空间。
- 字："字"由若干个字节构成，字的位数叫做字长，不同档次的机器有不同的字长。例如一台8位机，它的1个字就等于1个字节，字长为8位。如果是一台16位机，那么，它的1个字就由2个字节构成，字长为16位。字是计算机进行数据处理和运算的单位。
- 一般的计算机都已经到了64位机  也就是说 一个基本单位就是64位，也就是8字节了。这样再综合上面的分析就不难看出，结构体，共用体，位域的定义中，按顺序分配内存，下一个字段所占大小如果超出了上一个字段占的内存单元剩余部分，那么它会重新申请下一个内存单元，而上一个多出部分将空着。


***


关于3楼：  
原文内容：  
“”共用体所占内存并非是9个char，即9个字节，而是double的两倍，即16个字节，而且每次输出都是它前面离它最近的值“”  
补充说明：  
这是因为字节对齐  
关于5楼：  
原文内容：  
“字节：8个二进制位构成1个"字节(Byte)"，它是存储空间的基本计量单位。1个字节可以储存1个英文字母或者半个汉字，换句话说，1个汉字占据2个字节的存储空间。”  
补充说明：  
一个汉字占几个字节的存储空间，要看汉字的编码格式；  
前不久测出的一个汉字占3个字节的存储空间；还没确定编码格式是UTF-8还是GB213


***


补充楼上；  
共用体所占内存并非是 9 个 char，即 9 个字节，而是 double 的两倍，即 16 个字节，而且每次输出都是它前面离它最近的值。  
补充说明： 这是因为字节对齐。  
**对齐原则：**  
- 【原则1】数据成员对齐规则：结构(struct)(或联合(union))的数据成员，第一个数据成员放在offset为0的地方，以后每个数据成员的对齐按照#pragma pack指定的数值和这个数据成员自身长度中，比较小的那个进行。
- 【原则2】结构(或联合)的整体对齐规则：在数据成员完成各自对齐之后，结构(或联合)本身也要进行对齐，对齐将按照#pragma pack指定的数值和结构(或联合)最大数据成员长度中，比较小的那个进行。  
- 【原则3】结构体作为成员：如果一个结构里有某些结构体成员，则结构体成员要从其内部最大元素大小的整数倍地址开始存储。
```
union Data{
    int i;
    float f;
    char str[9];
    double d;
}data;
```
按照原则 2，VS 中默认的是 #pragma park(8)，char[9] 长度为 9。
```
8<9;
```
按照 8 的倍数且 >9，则取为 16；


***


##
#### 返回 [C基础知识](../C基础知识.md)